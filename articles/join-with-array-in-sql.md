---
title: "é…åˆ—ã§JOINã™ã‚‹ in SQL"
publication_name: "aidemy"
emoji: "ğŸ’«"
type: "tech"
topics: ["sql"]

published: true
---

ã“ã®è¨˜äº‹ã¯ã€[PostgreSQLã§é…åˆ—ã®idã¨joinã—ã¦ä¸¦ã³æ›¿ãˆã‚‹ã®ãŒé›£ã—ã„](https://qiita.com/nishimura/items/575e642503139229059a)ã€ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

å‹•ä½œç¢ºèªã¯PostgreSQLã§è¡Œã£ã¦ã„ã¾ã™ã€‚

## ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

ã¾ãšå‰ææ¡ä»¶ã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è€ƒãˆã¾ã™ã€‚

```sql
CREATE TABLE user_groups (
    user_group_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL
    user_ids INTEGER ARRAY
);

CREATE TABLE users (
    user_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL
);
```

`INTEGER GENERATED BY DEFAULT AS IDENTITY` ã¯æ¨™æº–SQLã«ãŠã‘ã‚‹é€£ç•ªã®æ›¸ãæ–¹ã§ã™ã€‚
å‚è€ƒï¼šã€[Identity columns](https://qiita.com/nuko_yokohama/items/7d0d5525bcefaa3332ce)ã€

:::details ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

```sql
INSERT INTO
    users (name)
VALUES
    ('Ichiro'),
    ('Jiro'),
    ('Saburo'),
    ('Shiro'),
    ('Goro');

INSERT INTO
    user_groups (name, user_ids)
VALUES
    ('group_1', ARRAY[1, 3, 2]),
    ('group_2', ARRAY[3, 4, 5]);
```

:::

ã“ã®`user_groups`ã®`user_ids`ã§ç´ã¥ã‘ã¦`users`ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã™ã‚‹ã¨ã„ã†ã®ãŒã“ã®è¨˜äº‹ã®å†…å®¹ã«ãªã‚Šã¾ã™ã€‚

## ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ã†æ›¸ãæ–¹

`user_groups`ã®`user_ids`ã§ç´ã¥ã‘ã¦`users`ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€`GROUP BY`ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```sql
SELECT
    user_groups.user_group_id,
    user_groups.name,
    (
        SELECT
            json_agg(users)
        FROM
            users
        WHERE
            users.user_id = any(user_groups.user_ids)
    ) AS users
FROM
    user_groups;
```

`users.user_id = any(user_groups.user_ids)` ã¯ç­‰å·ãŒæˆã‚Šç«‹ã¤è¦ç´ ãŒ`user_groups.user_ids`ã«å­˜åœ¨ã™ã‚‹ã¨ã`TRUE`ã¨ãªã‚Šã¾ã™ã€‚[^1]

ãŸã ã—ã€ã“ã®æ›¸ãæ–¹ã§ã¯é…åˆ—å†…ã®é †åºãŒç¶­æŒã•ã‚Œã‚‹ä¿è¨¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
ã¤ã¾ã‚Š `user_groups.user_ids` ã¨ç•°ãªã‚‹é †ç•ªã§`users`ã®ä¸­èº«ãŒä¸¦ã¶å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
ãã“ã§ã€é…åˆ—ã®é †åºã‚’ç¶­æŒã•ã›ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚ã‚¯ã‚¨ãƒªã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```sql
SELECT
    user_groups.user_group_id,
    user_groups.name,
    (
        SELECT
            json_agg(users ORDER BY user_ids.i)
        FROM
            unnest(user_groups.user_ids) WITH ORDINALITY AS user_ids(user_id, i)
        JOIN users USING (user_id)
    ) AS users
FROM
    user_groups;
```

é †ã‚’è¿½ã£ã¦ä¸Šã®ã‚³ãƒ¼ãƒ‰ã‚’èª¬æ˜ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

ã¾ãš `unnest(user_groups.user_ids) WITH ORDINALITY AS user_ids(user_id, i)` ã‹ã‚‰èª¬æ˜ã—ã¾ã™ã€‚
`unnest(user_groups.user_ids)` ã§`user_ids`ã‚’é…åˆ—ã‚’ãƒ†ãƒ¼ãƒ–ãƒ« (ã‚ˆã‚Šæ­£ç¢ºã«ã¯è¡Œã®é›†åˆ) ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚[^2]
`WITH ORDINALITY` ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ—ã¨ã—ã¦é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (1å§‹ã¾ã‚Š) ã‚’åŠ ãˆã¦ã„ã¾ã™ã€‚[^3]
ã¤ã¾ã‚Šã€user_groups.user_idsã®ä¸­èº«ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åˆ—ã¨ã—ã¦æŒã¤ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚
`AS user_ids(user_id, i)` ã§ä¸Šè¨˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã«`user_ids`ã€`user_groups.user_ids`ã®ä¸­èº«ã«`user_id`ã€é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«`i` ã¨ã„ã†ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

æ¬¡ã« `JOIN users USING (user_id)` ã§`users`ã‚’`JOIN`ã—ã¦ã€`json_agg(users ORDER BY user_ids.i) AS users` ã§é›†ç´„ã—ã¦ã„ã¾ã™ã€‚
`json_agg`ã¯å…¥åŠ› (`users`) ã‚’JSONã®é…åˆ—ã¨ã—ã¦æ ¼ç´ã—ã¾ã™ã€‚[^4]
`ORDER BY user_ids.i` ã§`user_ids`ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨åŒã˜é †åºã§é…åˆ—ã®è¦ç´ ãŒä¸¦ã¶ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚[^4]

ã“ã‚Œã§ã‚„ã‚ŠãŸã‹ã£ãŸã‚¯ã‚¨ãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

## ä»–ã®æ–¹æ³•

é…åˆ—ã®é †åºã‚’å•ã‚ãªã„ãªã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ã«`GROUP BY`ã§æ›¸ãã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```sql
SELECT
    user_groups.user_group_id,
    user_groups.name,
    json_agg(users) AS users
FROM
    user_groups
JOIN
    users ON users.user_id = ANY(user_groups.user_ids)
GROUP BY
    user_groups.user_group_id;
```

é…åˆ—ã®é †åºã‚’ç¶­æŒã™ã‚‹å ´åˆã€é…åˆ—ã‚’ä½œæˆã™ã‚‹å ´æ‰€ã‚’ã‚µãƒ–ã‚¯ã‚¨ãƒªã®ã¨ãã¨ç•°ãªã‚‹å ´æ‰€ã§è¡Œã†ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```sql
SELECT
    user_groups.user_group_id,
    user_groups.name,
    user_arrays.user_array AS users
FROM
    user_groups
LEFT JOIN LATERAL (
    SELECT
        json_agg(users ORDER BY user_ids.i) AS user_array
    FROM
        unnest(user_groups.user_ids) WITH ORDINALITY AS user_ids(user_id, i)
    JOIN users USING (user_id)
) user_arrays ON true
ORDER BY
    user_groups.user_group_id;
```

`JOIN`ã™ã‚‹é›†åˆã¯ `unnest(user_groups.user_ids)`ã®ç®‡æ‰€ã§`user_groups`ã‚’å‚ç…§ã—ã¦ã„ã¾ã™ã€‚
ã“ã®ã‚ˆã†ã«JOINã™ã‚‹é›†åˆãŒå‰ã®`FROM`å¥ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¾å­˜ã—ã¦ã„ã‚‹ã¨ãã«`LATERAL`ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§`LEFT JOIN LATERAL` ã¨æ›¸ã„ã¦ã„ã¾ã™ã€‚[^5]

[^1]: https://www.postgresql.jp/document/15/html/functions-comparisons.html#id-1.5.8.32.20
[^2]: https://www.postgresql.jp/document/15/html/functions-array.html
[^3]: https://www.postgresql.jp/document/15/html/functions-srf.html
[^4]: https://www.postgresql.jp/document/15/html/functions-aggregate.html
[^5]: https://www.postgresql.jp/document/15/html/queries-table-expressions.html#QUERIES-LATERAL

## ãŠã‚ã‚Šã«

é…åˆ—ã§ç´ã¥ã‘ã¦JOINã™ã‚‹æ–¹æ³•ã‚’èª¿ã¹ã¦ã¿ãŸã¨ã“ã‚ã€å‰æçŸ¥è­˜ãŒå¤šãèª¿ã¹ã‚‹ã®ãŒå¤§å¤‰ã ã£ãŸã®ã§è¨˜äº‹ã«ã—ã¾ã—ãŸã€‚
ã“ã®è¨˜äº‹ãŒã“ã‚Œã‹ã‚‰å­¦ç¿’ã™ã‚‹äººã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
