---
title: "é…åˆ—ã§JOINã™ã‚‹ in SQL"
publication_name: "aidemy"
emoji: "ğŸ’«"
type: "tech"
topics: ["sql"]

published: true
---

ã“ã®è¨˜äº‹ã¯ã€[PostgreSQLã§é…åˆ—ã®idã¨joinã—ã¦ä¸¦ã³æ›¿ãˆã‚‹ã®ãŒé›£ã—ã„](https://qiita.com/nishimura/items/575e642503139229059a)ã€ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

å‹•ä½œç¢ºèªã¯PostgreSQLã§è¡Œã£ã¦ã„ã¾ã™ã€‚

## ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è€ƒãˆã¾ã™ã€‚

```sql
CREATE TABLE user_groups (
    user_group_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL
    user_ids INTEGER ARRAY
);

CREATE TABLE users (
    user_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL
);
```

`INTEGER GENERATED BY DEFAULT AS IDENTITY` ã¯æ¨™æº–SQLã«ãŠã‘ã‚‹é€£ç•ªã®æ›¸ãæ–¹ã§ã™ã€‚
å‚è€ƒï¼šã€[Identity columns](https://qiita.com/nuko_yokohama/items/7d0d5525bcefaa3332ce)ã€

:::details ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

```sql
INSERT INTO
    users (name)
VALUES
    ('Ichiro'),
    ('Jiro'),
    ('Saburo'),
    ('Shiro'),
    ('Goro');

INSERT INTO
    user_groups (name, user_ids)
VALUES
    ('group_1', ARRAY[1, 3, 2]),
    ('group_2', ARRAY[3, 4, 5]);
```

:::

ã“ã®`user_groups`ã®`user_ids`ã§ç´ã¥ã‘ã¦`users`ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸã„ã¨ã„ã†ã®ãŒã“ã®è¨˜äº‹ã®å†…å®¹ã«ãªã‚Šã¾ã™ã€‚

## é…åˆ—ã§JOINã™ã‚‹

`GROUP BY`ã‚’ä½¿ã£ãŸã‚‚ã®ã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```sql
SELECT
    user_groups.user_group_id,
    user_groups.name,
    json_agg(users) AS users
FROM
    user_groups
    JOIN users ON users.user_id = ANY(user_groups.user_ids)
GROUP BY
    user_groups.user_group_id;
```

`users.user_id = any(user_groups.user_ids)` ã¯ç­‰å·ãŒæˆã‚Šç«‹ã¤è¦ç´ ãŒ`user_groups.user_ids`ã«å­˜åœ¨ã™ã‚‹ã¨ã`TRUE`ã¨ãªã‚Šã¾ã™ã€‚[^1]

ä¸Šè¨˜ã®æ›¸ãæ–¹ã«ã¯é…åˆ—å†…ã®é †åºãŒç¶­æŒã•ã‚Œã‚‹ä¿è¨¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
ã¤ã¾ã‚Š `user_groups.user_ids` ã¨ç•°ãªã‚‹é †ç•ªã§ `json_agg(users)` ã®ä¸­èº«ãŒä¸¦ã¶å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
ãã“ã§ã€é…åˆ—ã®é †åºã‚’ç¶­æŒã•ã›ã‚‹ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```sql
SELECT
    user_groups.user_group_id,
    user_groups.name,
    user_arrays.user_array
FROM
    user_groups
    LEFT JOIN LATERAL (
        SELECT
            json_agg(
                users
                ORDER BY
                    user_ids.i
            ) AS user_array
        FROM
            unnest(user_groups.user_ids) WITH ordinality AS user_ids(user_id, i)
            JOIN users USING (user_id)
    ) user_arrays ON true
ORDER BY
    user_groups.user_group_id;
```

é †ã‚’è¿½ã£ã¦ä¸Šã®ã‚³ãƒ¼ãƒ‰ã‚’èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚
ã¾ãš `unnest(user_groups.user_ids) with ordinality as user_ids(user_id, i)` ã‹ã‚‰èª¬æ˜ã—ã¾ã™ã€‚
`unnest(user_groups.user_ids)` ã§`user_ids`ã‚’é…åˆ—ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚[^2]
`with ordinality` ã§è¡Œã®é›†åˆã«é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (1å§‹ã¾ã‚Š) ã‚’åŠ ãˆã¦ã„ã¾ã™ã€‚[^3]
`as user_ids(user_id, i)` ã§ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ã—ã¦ã„ã¦ã€è¡Œã®é›†åˆã«`user_ids`ã€`user_groups.user_ids`ã‚’`unnest`ã—ãŸã‚‚ã®ã«`user_id`ã€é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«`i` ã¨ã„ã†ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

æ¬¡ã« `join users using (user_id)` ã§`users`ã‚’`JOIN`ã—ã¦ã€`json_agg(users order by user_ids.i) as user_array` ã§é›†ç´„ã—ã¦ã„ã¾ã™ã€‚
`json_agg`ã¯å…¥åŠ›ã‚’JSONã®é…åˆ—ã¨ã—ã¦æ ¼ç´ã—ã¾ã™ã€‚[^4]
`order by user_ids.i` ã§é…åˆ—ã®é †åºã§ä¸¦ã¶ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚[^4]

`left join lateral` ã¨ãªã£ã¦ã„ã‚‹éƒ¨åˆ†ã§ã™ãŒã€`JOIN`ã™ã‚‹é›†åˆã¯ `unnest(user_groups.user_ids)`ã§`user_groups`ã‚’å‚ç…§ã—ã¦ã„ã¾ã™ã€‚
ã“ã®ã‚ˆã†ã«JOINã™ã‚‹é›†åˆãŒå‰ã®`FROM`å¥ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¾å­˜ã—ã¦ã„ã‚‹ã¨ãã«`LATERAL`ã‚’æŒ‡å®šã—ã¾ã™ã€‚[^5]

[^1]: https://www.postgresql.jp/document/15/html/functions-comparisons.html#id-1.5.8.32.20
[^2]: https://www.postgresql.jp/document/15/html/functions-array.html
[^3]: https://www.postgresql.jp/document/15/html/functions-srf.html
[^4]: https://www.postgresql.jp/document/15/html/functions-aggregate.html
[^5]: https://www.postgresql.jp/document/15/html/queries-table-expressions.html#QUERIES-LATERAL

## ãŠã‚ã‚Šã«

é…åˆ—ã§JOINã™ã‚‹ãŸã‚ã®æ›¸ãæ–¹ã‚’ç†è§£ã™ã‚‹ã¾ã§ã«å‹‰å¼·ã—ãŸã“ã¨ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚

`users`ã«ã•ã‚‰ã«ä»–ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’`JOIN`ã™ã‚‹å ´åˆã¯ã‚‚ã†ä¸€å·¥å¤«å¿…è¦ã«ãªã‚Šã¾ã™ã€‚
ãã®å ´åˆã«ã¤ã„ã¦ã¯ã€ã“ã®è¨˜äº‹ã®å†…å®¹ã®å‚è€ƒã«ã—ãŸã€[PostgreSQLã§é…åˆ—ã®idã¨joinã—ã¦ä¸¦ã³æ›¿ãˆã‚‹ã®ãŒé›£ã—ã„](https://qiita.com/nishimura/items/575e642503139229059a)ã€ã‚’ã”å‚ç…§ãã ã•ã„ã€‚
