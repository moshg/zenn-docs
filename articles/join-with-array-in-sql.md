---
title: "配列でJOINする in SQL"
publication_name: "aidemy"
emoji: "💫"
type: "tech"
topics: ["sql"]

published: true
---

この記事は『[PostgreSQLで配列のidとjoinして並び替えるのが難しい](https://qiita.com/nishimura/items/575e642503139229059a)』を参考にしています。

動作確認はPostgreSQLで行っています。

## テーブル定義

以下のようにユーザーテーブルとユーザーグループテーブルを考えます。

```sql
CREATE TABLE user_groups (
    user_group_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL
    user_ids INTEGER ARRAY
);

CREATE TABLE users (
    user_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL
);
```

`INTEGER GENERATED BY DEFAULT AS IDENTITY` は標準SQLにおける連番の書き方です。
参考：『[Identity columns](https://qiita.com/nuko_yokohama/items/7d0d5525bcefaa3332ce)』

:::details データ投入

```sql
INSERT INTO
    users (name)
VALUES
    ('Ichiro'),
    ('Jiro'),
    ('Saburo'),
    ('Shiro'),
    ('Goro');

INSERT INTO
    user_groups (name, user_ids)
VALUES
    ('group_1', ARRAY[1, 3, 2]),
    ('group_2', ARRAY[3, 4, 5]);
```

:::

この`user_groups`の`user_ids`で紐づけて`users`テーブルのデータを取得したいというのがこの記事の内容になります。

## 配列でJOINする

`GROUP BY`を使ったものとして以下のように書くことができます。

```sql
SELECT
    user_groups.user_group_id,
    user_groups.name,
    json_agg(users) AS users
FROM
    user_groups
    JOIN users ON users.user_id = ANY(user_groups.user_ids)
GROUP BY
    user_groups.user_group_id;
```

`users.user_id = any(user_groups.user_ids)` は等号が成り立つ要素が`user_groups.user_ids`に存在するとき`TRUE`となります。[^1]

上記の書き方には配列内の順序が維持される保証がありません。
つまり `user_groups.user_ids` と異なる順番で `json_agg(users)` の中身が並ぶ可能性があります。
そこで、配列の順序を維持させるには以下のように書くことができます。

```sql
SELECT
    user_groups.user_group_id,
    user_groups.name,
    user_arrays.user_array
FROM
    user_groups
    LEFT JOIN LATERAL (
        SELECT
            json_agg(
                users
                ORDER BY
                    user_ids.i
            ) AS user_array
        FROM
            unnest(user_groups.user_ids) WITH ordinality AS user_ids(user_id, i)
            JOIN users USING (user_id)
    ) user_arrays ON true
ORDER BY
    user_groups.user_group_id;
```

順を追って上のコードを説明していきます。
まず `unnest(user_groups.user_ids) with ordinality as user_ids(user_id, i)` から説明します。
`unnest(user_groups.user_ids)` で`user_ids`を配列をテーブルに変換しています。[^2]
`with ordinality` で行の集合に配列のインデックス (1始まり) を加えています。[^3]
`as user_ids(user_id, i)` でエイリアスをしていて、行の集合に`user_ids`、`user_groups.user_ids`を`unnest`したものに`user_id`、配列のインデックスに`i` というエイリアスを指定しています。

次に `join users using (user_id)` で`users`を`JOIN`して、`json_agg(users order by user_ids.i) as user_array` で集約しています。
`json_agg`は入力をJSONの配列として格納します。[^4]
`order by user_ids.i` で配列の順序で並ぶようにしています。[^4]

`left join lateral` となっている部分ですが、`JOIN`する集合は `unnest(user_groups.user_ids)`で`user_groups`を参照しています。
このようにJOINする集合が前の`FROM`句のテーブルに依存しているときに`LATERAL`を指定します。[^5]

[^1]: https://www.postgresql.jp/document/15/html/functions-comparisons.html#id-1.5.8.32.20
[^2]: https://www.postgresql.jp/document/15/html/functions-array.html
[^3]: https://www.postgresql.jp/document/15/html/functions-srf.html
[^4]: https://www.postgresql.jp/document/15/html/functions-aggregate.html
[^5]: https://www.postgresql.jp/document/15/html/queries-table-expressions.html#QUERIES-LATERAL

## おわりに

配列でJOINするための書き方を理解するまでに勉強したことをまとめました。

`users`にさらに他のテーブルを`JOIN`する場合はもう一工夫必要になります。
その場合については、この記事の内容の参考にした『[PostgreSQLで配列のidとjoinして並び替えるのが難しい](https://qiita.com/nishimura/items/575e642503139229059a)』をご参照ください。
