---
title: "PostgreSQLã§è¡Œã«è¤‡æ•°ç´ã¥ããƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã¨ã—ã¦ä¸€ç™ºã§å–å¾—ã™ã‚‹"
publication_name: "aidemy"
emoji: "ğŸ¥Œ"
type: "tech"
topics: ["sql", "postgresql"]

published: false
---

## ã¾ãˆãŒã

ã€Œgroupâˆ‹itemã€ã®ã‚ˆã†ãªå…¥ã‚Œå­æ§‹é€ ãŒã‚ã‚‹ã¨ãã€SQLã§ãƒ‡ãƒ¼ã‚¿ã‚’ã©ã†å–å¾—ã™ã‚‹ã‹ã‚’è¿·ã£ãŸã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ
SQLã«ãŠã„ã¦è¤‡æ•°ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—ã™ã‚‹ã¨ãã«ã€ã‚¢ã‚¤ãƒ†ãƒ ã‚‚ä¸€ç·’ã«å–å¾—ã™ã‚‹ã®ã¯ã‚ã¾ã‚Šç°¡å˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ç§ã¯åˆã‚ã¦SQLã«è§¦ã£ãŸã¨ãã«ã©ã†ã™ã‚Œã°ã„ã„ã‹ã‚ã‹ã‚‰ãšã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ç„¡ç†ã‚„ã‚Šå®Ÿç¾ã—ãŸè¨˜æ†¶ãŒã‚ã‚Šã¾ã™ã€‚[^orm]
ãã“ã§å½“æ™‚ã®è‡ªåˆ†ã®ã‚ˆã†ãªäººã«å‘ã‘ã¦ã€SQLã§å…¥ã‚Œå­ã«ãªã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼

[^orm]: ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã˜ã‚ƒãªãORãƒãƒƒãƒ‘ãƒ¼ã‚’ä½¿ã£ã¦ã„ã‚Œã°ã€å‹æ‰‹ã«ã„ã„æ„Ÿã˜ã«ã‚„ã£ã¦ãã‚Œã¦å›°ã‚‰ãšã«æ¸ˆã‚“ã ã¨ã„ã†èª¬ã‚‚ã‚ã‚‹

å‹•ä½œç¢ºèªã¯PostgreSQL 15.3ã§è¡Œã£ã¦ã„ã¾ã™ã€‚

## ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

ã¾ãšä»¥ä¸‹ã®ã‚ˆã†ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è€ƒãˆã¾ã™ã€‚

```sql
CREATE TABLE groups (
    group_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL
);

CREATE TABLE items (
    group_id INTEGER,
    item_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    FOREIGN KEY (group_id) REFERENCES groups(group_id)
);
```

`INTEGER GENERATED BY DEFAULT AS IDENTITY` ã¯æ¨™æº–SQLã«ãŠã‘ã‚‹é€£ç•ªã®æ›¸ãæ–¹ã§ã™ã€‚
å‚è€ƒï¼šã€[Identity columns](https://qiita.com/nuko_yokohama/items/7d0d5525bcefaa3332ce)ã€

:::details ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

```sql
INSERT INTO
    groups (name)
VALUES
    ('group_1'),
    ('group_2');

INSERT INTO
    items (group_id, name)
VALUES
    (1, 'item_1'),
    (1, 'item_2'),
    (2, 'item_3');
```

:::

ã“ã®ã¨ãä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ãŸã„ã¨ã„ã†ã®ãŒã“ã®è¨˜äº‹ã®ç›®æ¨™ã«ãªã‚Šã¾ã™ã€‚

|group_id|name|items|
|-|-|-|
|1|group_1|[{ item_id: 1, name: "item_1" }, { item_id: 2, name: "item_2" }]|
|2|group_2|[{ item_id: 3, name: "item_3" }]|

## ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã¨ã—ã¦å–å¾—ã™ã‚‹

ã„ããªã‚Šçµè«–ã§ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚[^jsonb]

```sql
select
    groups.group_id AS id,
    groups.name,
    (
        select
            jsonb_agg(items)
        from
            items
        where
            items.group_id = groups.group_id
    ) as items
from
    groups
```

`jsonb_agg`[^jsonb_agg]ã¯é›†ç´„é–¢æ•°ã§ã‚ã‚Šã€å…¥åŠ›ã‚’JSONé…åˆ—ã«æ ¼ç´ã—ã¾ã™ã€‚

[^jsonb]: JSONBã¨ã¯ä½•ã‹ã®è§£èª¬ï¼šã€[PostgreSQLã®json/jsonbå‹](https://zenn.dev/snagasawa/articles/postgresql_json_and_jsonb_type)ã€
JSONã§ã¯ãªãJSONBã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã¯ãªã‚“ã¨ãªãã§ã™
[^jsonb_agg]: https://www.postgresql.jp/document/15/html/functions-aggregate.html

ã“ã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã™ã€‚

|group_id|name|items|
|-|-|-|
|1|group_1|[{"name": "item_1", "item_id": 1, "group_id": 1}, {"name": "item_2", "item_id": 2, "group_id": 1}]|
|2|group_2|[{"name": "item_3", "item_id": 3, "group_id": 2}]|

ã‚‚ã—ä½œæˆæ—¥æ™‚ãªã©ã§é…åˆ—ã®è¦ç´ ã®é †ç•ªã‚’åˆ¶å¾¡ã—ãŸã„ã®ã§ã‚ã‚Œã°ä»¥ä¸‹ã®ã‚ˆã†ã«é›†ç´„æ™‚ã«`ORDER BY`ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚[^order-by]

[^order-by]: https://www.postgresql.jp/document/15/html/sql-expressions.html#SYNTAX-AGGREGATES

```sql
jsonb_agg(items ORDER BY items.created_at) -- ã“ã®è¨˜äº‹ã§å®šç¾©ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã«created_atã¯ãªã„ãŒä¾‹ã¨ã—ã¦
```

ãŸã ã—`items`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã¾ã‚‹ã”ã¨`jsonb_agg`ã§å–ã‚Šè¾¼ã‚“ã§ã—ã¾ã£ãŸã®ã§ã€`items`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«`group_id`ãŒå«ã¾ã‚Œã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚
`item_id`, `name` ã ã‘ã«çµã‚ŠãŸã„å ´åˆã¯`jsonb_build_object`[^jsonb-fn]ã¨ã„ã†JSONBã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹é–¢æ•°ãŒä½¿ãˆã¾ã™ã€‚
`jsonb_build_object`ã®ä½¿ã„æ–¹ã®ä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```sql
jsonb_build_object('foo', 1, 'bar', 'baz') -- { "foo": 1, "bar": "baz" }
```

[^jsonb-fn]: https://www.postgresql.jp/document/15/html/functions-json.html

ã“ã®`jsonb_build_object`ã‚’ä½¿ã£ã¦ã‚¯ã‚¨ãƒªã‚’æ›¸ãæ›ãˆã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```sql
select
    groups.group_id,
    groups.name,
    (
        select
            jsonb_agg(jsonb_build_object(
                'item_id', items.item_id,
                'name', items.name
            ))
        from
            items
        where
            items.group_id = groups.group_id
    ) as items
from
    groups
```

ã“ã‚Œã§æ¬²ã—ã‹ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã—ãŸï¼

|group_id|name|items|
|-|-|-|
|1|group_1|[{ item_id: 1, name: "item_1" }, { item_id: 2, name: "item_2" }]|
|2|group_2|[{ item_id: 3, name: "item_3" }]|

## ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã¨ã—ã¦å–å¾—ã™ã‚‹ (å…¥ã‚Œå­ãŒå¤šé‡ã®å ´åˆ)

ã•ã‚‰ã«å…¥ã‚Œå­ã«ãªã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å ´åˆã‚‚è¦‹ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
è¿½åŠ ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¢ã‚¤ãƒ†ãƒ ã®å±æ€§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è€ƒãˆã¾ã™ã€‚

```sql
CREATE TABLE attributes (
    item_id INTEGER,
    attr_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    FOREIGN KEY (item_id) REFERENCES items(item_id)
);
```

:::details ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

```sql
INSERT INTO
    attributes (item_id, name)
VALUES
    (1, 'attr_1'),
    (1, 'attr_2'),
    (3, 'attr_3'),
    (2, 'attr_4');
```

:::

ã“ã®ã¨ãã‚‚å¯¾å¿œã—ã¦ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ã•ã‚‰ã«å…¥ã‚Œå­ã«ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã™ã€‚

```sql
select
    groups.group_id,
    groups.name,
    (
        select
            jsonb_agg(jsonb_build_object(
            	'name', items.name,
                'item_id', items.item_id,
                'attributes', (
                    select
                        jsonb_agg(jsonb_build_object(
                        	'attr_id', attrs.attr_id,
                            'name', attrs.name
                        )) as attributes
                    from
                        attributes AS attrs
                    where
                        attrs.item_id = items.item_id
                )
            ))
        from
            items
        where
            items.group_id = groups.group_id
    ) as items
from
    groups
```

|group_id|name|items|
|-|-|-|
|1|group_1|[{"name": "item_1", "item_id": 1, "attributes": [{"name": "attr_1", "attr_id": 1}, {"name": "attr_2", "attr_id": 2}]}, {"name": "item_2", "item_id": 2, "attributes": [{"name": "attr_4", "attr_id": 4}]}]|
|2|group_2|[{"name": "item_3", "item_id": 3, "attributes": [{"name": "attr_3", "attr_id": 3}]}]|

## ã‚ã¨ãŒã

SQLãŒæ¡ˆå¤–é«˜æ©Ÿèƒ½ã§é©šãã¾ã™ã­ã€‚
SQLã ã‘ã§ã‚‚æ™®é€šã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã®ã‚ˆã†ã«ãƒã‚¹ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å®Ÿç¾ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿å‘¨ã‚Šã®å‡¦ç†ã‚’DBã«ä»»ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã®è¨˜äº‹ãŒå½“æ™‚ã®è‡ªåˆ†ã®ã‚ˆã†ãªäººã®åŠ©ã‘ã«ãªã£ã¦ã„ã‚Œã°å¬‰ã—ã„ã§ã™ï¼

æœ€å¾Œã«ã€ãƒ‡ãƒ¼ã‚¿ã®å…¥ã‚Œå­ã‚’å­ã‹ã‚‰ã®å‚ç…§ã§ã¯ãªãã€è¦ªã‹ã‚‰ã®å‚ç…§ (é…åˆ—) ã§è¡¨ç¾ã—ã¦ã„ã‚‹å ´åˆã®è¨˜äº‹ã‚’å®£ä¼ã—ã¦ãŠãã¾ã™: ã€[é…åˆ—ã§JOINã™ã‚‹ in SQL](https://zenn.dev/aidemy/articles/join-with-array-in-sql)ã€
